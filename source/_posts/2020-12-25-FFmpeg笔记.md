---
title: FFmpeg笔记
pathsuffix: ffmpeg-note
date: 2020-12-25 11:17:18
tags: FFmpeg
comments: false
category: 技术
toc: true
---
# Mac/Linux下编译ffmpeg

`./configure --prefix=/usr/local/ffmpeg --enable-debug=3 --disable-static --enable-shared --enable-libfdk-aac --enable-gpl --enable-nonfree`
参数含义：

>  --prefix 指定安装路径
>  --enable-debug=3 打开调试模式，级别是3
>  --disable-static 关闭静态库
>  --enable-share 打开动态库

执行完会产生编译脚本make file

```
make -j 4
make install
```

参数含义：

> -j 表示同时有多个CPU并发进行
> 最后安装到 **--prefix**指定的路径


# HelloWorld

```c
#include<stdio.h>
int main(int argc, char* atgv[]){
    printf("Hello World!\n");
    return 0;
}
```

编译命令：
` gcc/clang -g -o HelloWorld HelloWorld.c`
参数含义：

> gcc Linux下的命令
> clang Mac下的命令
> -g debug模式
> -o 要输出文件的名字，这里是HelloWorld
> xxx.c 源代码
> 执行命令：
> ` ./HelloWorld`

# 命令方式采集音频

Mac系统
` ffmpeg -f avfoundation -i :0 out.wav`
Linux系统
` ffmpeg -f asla -i hw:0 out.wav`

# 播放音频

` ffplay -ar 44100 -ac 2 -f f32le audio.pcm`

# 使用ffmpeg生成aac

` ffmpeg -i xxx.mp4 -vn -c:a libfdk_aac -ar 44100 -channels 2 -profile:a aac_he_v2 xxx.aac`
参数含义：

> -i 输入的文件
> -vn v代表video，n代表没有video，vn可以将视频过滤掉
> -c:a c代表编码器，a代表音频编码器
> -ar 音频采样率
> -channels 代表通道数
> -profile:a 对编码器libfdk_aac设置参数，:a是对音频的编码

缺少库安装：
` brew reinstall ffmpeg --with-sdl2 --with-fdk-aac --with-fontconfig`

` brew install --with-sdl2 --with-fdk-aac --with-fontconfig --with-frei0r --with-game-music-emu --with-libass --with-libbs2b --with-libcaca --with-libgsm --with-libmodplug --with-librsvg --with-libsoxr --with-libssh --with-libvidstab --with-libvorbis --with-libvpx --with-opencore-amr --with-openh264 --with-openjpeg --with-openssl --with-opus --with-rtmpdump --with-rubberband --with-sdl2 --with-snapp --with-speex --with-srt --with-tesseract --with-theora --with-tools --with-two-lame --with-wavpack --with-webp --with-x265 --with-xz --with-zeromq --with-zimg --with-chromaprint --with-libbluray --with-snappy  --with-freetype`

![视频播放器原理](视频播放器原理.png)


# [Windows build 下载](ffmpeg-4.3.2-2021-02-27-full_build.7z)
# 剪切视频（长度）

` ffmpeg -ss 990 -i input.mp4 -t 50 output.mp4`

> -ss 开始的秒数
> -t 截取时长
> -s 调整分辨率

# 剪切视频 (尺寸、长度)

```sh
ffmpeg -i input -vf crop=w:h:x:y -ss start_time -t duration output
```

<table>
    <tr>
        <th align="center" width="20%">Syntax</th>
        <th align="center">crop=ow[:oh[:x[:y[:keep_aspect]]]]</th> 
    </tr >
    <tr>
        <th colspan="2" align="center">Avaliable variables in expressions for <u>ow</u> and <u>oh</u> parameters</th>
    </tr>
    <tr>
        <td align="center">x, y</td>
        <td>computed values for x (number of pixels from top left corner horizontally) and y (number of pixels vertically), they are evaluated for every frame, default values of <b>x</b> is (iw -ow)/2, default value of <b>y</b> is (ih - oh)/2</td>
    </tr>
    <tr>
        <td align="center">in_w, iw</td>
        <td>input width</td>
    </tr>
    <tr>
        <td align="center">in_h, ih</td>
        <td>input height</td>
    </tr>
    <tr>
        <td align="center">out_w, ow</td>
        <td>output(cropped) width, default value = iw</td>
    </tr>
    <tr>
        <td align="center">out_h, oh</td>
        <td>output(cropped) heigth, default value = ih</td>
    </tr>
    <tr>
        <td align="center">a</td>
        <td>aspect ratio, same as iw/ih</td>
    </tr>
    <tr>
        <td align="center">sar</td>
        <td>input same aspect ratio</td>
    </tr>
    <tr>
        <td align="center">dar</td>
        <td>input display aspect ratio, equals to the expression a*sar</td>
    </tr>
    <tr>
        <td align="center">hsub, vsub</td>
        <td>horizontal and vertical chroma subsample values, for the pixel format yuv422p the value of hsub is 2 and vsub is 1</td>
    </tr>
    <tr>
        <td align="center">n</td>
        <td>number of input frame, starting from 0</td>
    </tr>
    <tr>
        <td align="center">pos</td>
        <td>position in the file of the input frame, NAN if unknown</td>
    </tr>
    <tr>
        <td align="center">t</td>
        <td>timestamp expressed in seconds, NAN if the input timestamp is unknown</td>
    </tr>
</table>

+ Example:

```sh
PS E:\Download> ffmpeg -i .\权力的游戏.第一季.第1集.Game.of.Thrones.S01E01.HK.BD-1080p.X264.AAC.CHS.ENG-UUMp4.mp4 -vf crop=600:800:iw/6:ih/6 -ss 300 -t 60 out.mp4
ffmpeg version 4.3.2-2021-02-27-full_build-www.gyan.dev Copyright (c) 2000-2021 the FFmpeg developers
  built with gcc 10.2.0 (Rev6, Built by MSYS2 project)
  configuration: --enable-gpl --enable-version3 --enable-static --disable-w32threads --disable-autodetect --enable-fontconfig --enable-iconv --enable-gnutls --enable-libxml2 --enable-gmp --enable-lzma --enable-libsnappy --enable-zlib --enable-libsrt --enable-libssh --enable-libzmq --enable-avisynth --enable-libbluray --enable-libcaca --enable-sdl2 --enable-libdav1d --enable-libzvbi --enable-librav1e --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxvid --enable-libaom --enable-libopenjpeg --enable-libvpx --enable-libass --enable-frei0r --enable-libfreetype --enable-libfribidi --enable-libvidstab --enable-libvmaf --enable-libzimg --enable-amf --enable-cuda-llvm --enable-cuvid --enable-ffnvcodec --enable-nvdec --enable-nvenc --enable-d3d11va --enable-dxva2 --enable-libmfx --enable-libcdio --enable-libgme --enable-libmodplug --enable-libopenmpt --enable-libopencore-amrwb --enable-libmp3lame --enable-libshine --enable-libtheora --enable-libtwolame --enable-libvo-amrwbenc --enable-libilbc --enable-libgsm --enable-libopencore-amrnb --enable-libopus --enable-libspeex --enable-libvorbis --enable-ladspa --enable-libbs2b --enable-libflite --enable-libmysofa --enable-librubberband --enable-libsoxr --enable-chromaprint
  libavutil      56. 51.100 / 56. 51.100
  libavcodec     58. 91.100 / 58. 91.100
  libavformat    58. 45.100 / 58. 45.100
  libavdevice    58. 10.100 / 58. 10.100
  libavfilter     7. 85.100 /  7. 85.100
  libswscale      5.  7.100 /  5.  7.100
  libswresample   3.  7.100 /  3.  7.100
  libpostproc    55.  7.100 / 55.  7.100
Input #0, mov,mp4,m4a,3gp,3g2,mj2, from '.\权力的游戏.第一季.第1集.Game.of.Thrones.S01E01.HK.BD-1080p.X264.AAC.CHS.ENG-UUMp4.mp4':
  Metadata:
    major_brand     : mp42
    minor_version   : 1
    compatible_brands: isommp423gp5
    creation_time   : 2019-05-13T16:22:44.000000Z
    encoder         : My MP4Box GUI 0.6.0.6 <http://my-mp4box-gui.zymichost.com>
  Duration: 01:01:37.17, start: 0.000000, bitrate: 2586 kb/s
    Stream #0:0(und): Video: h264 (High) (avc1 / 0x31637661), yuv420p, 1920x1080 [SAR 1:1 DAR 16:9], 2485 kb/s, 23.98 fps, 23.98 tbr, 24k tbn, 47.95 tbc (default)
    Metadata:
      creation_time   : 2019-05-08T18:52:18.000000Z
      handler_name    : ȨfµÄÓÎϷ.µÚһ�¾.µÚ1�¯.Game.of.Thrones.S01E01.HK.BD-1080p.X264.AAC.CHS.ENG-UUMp4.mp4
      encoder         : AVC Coding
    Stream #0:1(und): Audio: aac (LC) (mp4a / 0x6134706D), 48000 Hz, stereo, fltp, 97 kb/s (default)
    Metadata:
      creation_time   : 2019-05-13T16:23:09.000000Z
      handler_name    : Game.of.Thrones.S01E01.HK.Blu-ray.1080p.Remux.H264.DTS-HD.MA.5.1.aac
    Stream #0:2(und): Data: none (mp4s / 0x7334706D), 0 kb/s (default)
    Metadata:
      creation_time   : 2019-05-13T16:23:11.000000Z
      handler_name    : GPAC MPEG-4 OD Handler
    Stream #0:3(und): Data: none (mp4s / 0x7334706D), 0 kb/s (default)
    Metadata:
      creation_time   : 2019-05-13T16:23:11.000000Z
      handler_name    : GPAC MPEG-4 Scene Description Handler
File 'out.mp4' already exists. Overwrite? [y/N] y
Stream mapping:
  Stream #0:0 -> #0:0 (h264 (native) -> h264 (libx264))
  Stream #0:1 -> #0:1 (aac (native) -> aac (native))
Press [q] to stop, [?] for help
[libx264 @ 00000155b6ac5980] using SAR=1/1
[libx264 @ 00000155b6ac5980] using cpu capabilities: MMX2 SSE2Fast SSSE3 SSE4.2 AVX FMA3 BMI2 AVX2
[libx264 @ 00000155b6ac5980] profile High, level 3.1, 4:2:0, 8-bit
[libx264 @ 00000155b6ac5980] 264 - core 161 r3048 b86ae3c - H.264/MPEG-4 AVC codec - Copyleft 2003-2021 - http://www.videolan.org/x264.html - options: cabac=1 ref=3 deblock=1:0:0 analyse=0x3:0x113 me=hex subme=7 psy=1 psy_rd=1.00:0.00 mixed_ref=1 me_range=16 chroma_me=1 trellis=1 8x8dct=1 cqm=0 deadzone=21,11 fast_pskip=1 chroma_qp_offset=-2 threads=6 lookahead_threads=1 sliced_threads=0 nr=0 decimate=1 interlaced=0 bluray_compat=0 constrained_intra=0 bframes=3 b_pyramid=2 b_adapt=1 b_bias=0 direct=1 weightb=1 open_gop=0 weightp=2 keyint=250 keyint_min=23 scenecut=40 intra_refresh=0 rc_lookahead=40 rc=crf mbtree=1 crf=23.0 qcomp=0.60 qpmin=0 qpmax=69 qpstep=4 ip_ratio=1.40 aq=1:1.00
Output #0, mp4, to 'out.mp4':
  Metadata:
    major_brand     : mp42
    minor_version   : 1
    compatible_brands: isommp423gp5
    encoder         : Lavf58.45.100
    Stream #0:0(und): Video: h264 (libx264) (avc1 / 0x31637661), yuv420p, 600x800 [SAR 1:1 DAR 3:4], q=-1--1, 23.98 fps, 24k tbn, 23.98 tbc (default)
    Metadata:
      creation_time   : 2019-05-08T18:52:18.000000Z
      handler_name    : ȨfµÄÓÎϷ.µÚһ�¾.µÚ1�¯.Game.of.Thrones.S01E01.HK.BD-1080p.X264.AAC.CHS.ENG-UUMp4.mp4
      encoder         : Lavc58.91.100 libx264
    Side data:
      cpb: bitrate max/min/avg: 0/0/0 buffer size: 0 vbv_delay: N/A
    Stream #0:1(und): Audio: aac (LC) (mp4a / 0x6134706D), 48000 Hz, stereo, fltp, 128 kb/s (default)
    Metadata:
      creation_time   : 2019-05-13T16:23:09.000000Z
      handler_name    : Game.of.Thrones.S01E01.HK.Blu-ray.1080p.Remux.H264.DTS-HD.MA.5.1.aac
      encoder         : Lavc58.91.100 aac
frame= 1439 fps= 48 q=-1.0 Lsize=    5577kB time=00:01:00.01 bitrate= 761.3kbits/s speed=1.99x
video:4594kB audio:942kB subtitle:0kB other streams:0kB global headers:0kB muxing overhead: 0.744073%
[libx264 @ 00000155b6ac5980] frame I:19    Avg QP:18.65  size: 26467
[libx264 @ 00000155b6ac5980] frame P:480   Avg QP:20.83  size:  5503
[libx264 @ 00000155b6ac5980] frame B:940   Avg QP:22.86  size:  1658
[libx264 @ 00000155b6ac5980] consecutive B-frames:  9.5%  8.6%  4.6% 77.3%
[libx264 @ 00000155b6ac5980] mb I  I16..4: 13.6% 77.6%  8.8%
[libx264 @ 00000155b6ac5980] mb P  I16..4:  6.2% 12.2%  0.4%  P16..4: 41.1%  8.5%  5.4%  0.0%  0.0%    skip:26.2%
[libx264 @ 00000155b6ac5980] mb B  I16..4:  0.7%  0.7%  0.0%  B16..8: 36.9%  1.7%  0.2%  direct: 1.0%  skip:58.7%  L0:45.0% L1:53.6% BI: 1.4%
[libx264 @ 00000155b6ac5980] 8x8 transform intra:65.0% inter:88.4%
[libx264 @ 00000155b6ac5980] coded y,uvDC,uvAC intra: 35.4% 42.5% 4.1% inter: 9.1% 13.9% 0.0%
[libx264 @ 00000155b6ac5980] i16 v,h,dc,p: 38% 23% 16% 24%
[libx264 @ 00000155b6ac5980] i8 v,h,dc,ddl,ddr,vr,hd,vl,hu: 22% 18% 37%  4%  4%  4%  4%  4%  4%
[libx264 @ 00000155b6ac5980] i4 v,h,dc,ddl,ddr,vr,hd,vl,hu: 22% 19% 18%  6%  9%  7%  8%  5%  5%
[libx264 @ 00000155b6ac5980] i8c dc,h,v,p: 64% 16% 19%  1%
[libx264 @ 00000155b6ac5980] Weighted P-Frames: Y:0.4% UV:0.4%
[libx264 @ 00000155b6ac5980] ref P L0: 69.3%  9.9% 15.6%  5.2%  0.0%
[libx264 @ 00000155b6ac5980] ref B L0: 88.0%  9.7%  2.2%
[libx264 @ 00000155b6ac5980] ref B L1: 96.9%  3.1%
[libx264 @ 00000155b6ac5980] kb/s:626.89
[aac @ 00000155b6abfb40] Qavg: 163.868
```